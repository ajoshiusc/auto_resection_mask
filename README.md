# Auto Resection Mask

This tools Coregisters pre and post-op MRI images and identifies resection.

Here is an [example dataset](https://drive.google.com/drive/folders/1vuI-YwELv8ZMxgxF7ioWN9ceHjArwV91) to run through the module. 

The code is documented in the jupyter notebook main_automask.ipynb

This notebook shows an example workflow to delineate resection on MRI image.

**Inputs**: Pre-op MRI image, Post-op MRI image  
**Outputs**: Post-op MRI image affinely registered to pre-op MRI image, resection mask (\<subject\>.resection.mask.nii.gz)

# Installation
* Make sure you have [BrainSuite](https://brainsuite.org) installed. 
* A devcontainer is available with the repository. Open `.devcontainer.json` file and set the data and code paths.
* Open the cloned folder using vscode. This will prompt you to open the repo in a devcontainer. Alternatively, you can configure a python environment by manually installing `requirements.txt`
* [BrainSuite](HTTP://brainsuite.org) needs to be installed on your system. If you don't have it, please [install it](https://brainsuite.org/quickstart/installation).

![image](https://github.com/ajoshiusc/auto_resection_mask/assets/15238551/09d32830-3ae0-4eaa-935e-22e280905dc6)

# Standalone binary (Windows, Linux and Mac)
 - Standalone binaries for this module are available: [Windows](https://neuroimage.usc.edu/bst/getupdate.php?d=bst_resection_labeling_win.zip), [Linux](https://neuroimage.usc.edu/bst/getupdate.php?d=bst_resection_labeling_linux.zip), [Mac](https://neuroimage.usc.edu/bst/getupdate.php?d=bst_resection_labeling_mac.zip).
 - Unzip the binary file and download data from the example dataset link above (or use your own data). <br>
   Usage: resection_identification preop_mri postop_mri [temp_dir]
     - preop_mri: Path to pre-operative MRI file
     - postop_mri: Path to post-operative MRI file
     - temp_dir: (Optional) Directory for bundled package extraction
                 If not specified, uses system temporary directory (in Linux this space can be very limited)
 - You can also build the binaries in your system from scratch. Please refer to the `BUILD_INSTRUCTIONS.md` for the detailed process.


# Usage

## Running the code
* NVIDIA GPU (for CUDA) is recommended however it can run on CPU as well.
* Please open `main_automask.ipynb` as a jupyter notebook, correct paths of our input pre-op and post-op MRIs and run the code.
* Assume as input, you have `preop.nii.gz` (pre-op MRI), and `post-op.nii.gz` (post-op MRI with resection). Open Python code `main_auto_resection_mask.py` in vscode.
* Correct the paths of the `auto_resection_module`, as well as paths to `preop.nii.gz` and `post-op.nii.gz`. Add the path to the BrainSuite installation folder.
* Run the notebook.

## Manually editing the resection mask

If you are not completely happy with the resection mask generated by the module, you can edit it in BrainSuite using the [Mask Tool](https://brainsuite.org/delineation/roi/masking).
Here is one example [video](https://brainsuite.org/video-tutorials/mask-editing-tool/) for mask editing using the Mask Tool (although the video shows different mask being edited, you can apply the same process to resection mask).
  
## Importing to BrainStorm
The resection mask created by the tool can be imported into [BrainStorm](https://neuroimage.usc.edu/brainstorm/Introduction) during import anatomy.
* Open BrainStorm, Import anatomy as a (BrainSuite processed folder)[https://neuroimage.usc.edu/brainstorm/Tutorials/SegBrainSuite].
* You will see `resection` (resection surface), and `resection_mask` (resection volume). You can visualize them in BrainStorm by right clicking and selecting options of your choice. 

![bstm_resection](https://github.com/ajoshiusc/auto_resection_mask/assets/15238551/4b90cf7a-7ed5-4436-b0dc-b2c5fe7128d6)


## Visualization in BrainSuite
* Open BrainSuite and load *pre-op.nii.gz*
* Click on `File->Overlay Volume` and select pre-op.post2pre.nii.gz" and load it. This is the post-op volume coregistred to pre-op volume.
* Click on `File->Open mask volume` and select resection.mask.nii.gz and load it. This will show outline of the identified resection.
* Goto `Tools->Mask Tool` and generate a surface.

<!--- ![buite_resection](https://github.com/ajoshiusc/auto_resection_mask/assets/15238551/dc06a0b2-4ed6-4743-a738-48d51f55cf60) --->

<img src="https://github.com/ajoshiusc/auto_resection_mask/assets/15238551/dc06a0b2-4ed6-4743-a738-48d51f55cf60)" alt="drawing" width="700"/>


## Support
* Please contact [Anand A Joshi](ajoshi@usc.edu) if you have any questions.





